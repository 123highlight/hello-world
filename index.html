<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èˆ¬è‹¥æ—¥å†</title>
    
    <!-- æ ¸å¿ƒåº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lunar-javascript/1.6.12/lunar.min.js"></script>
    <script>if(typeof Lunar === 'undefined') document.write('<script src="https://unpkg.com/lunar-javascript/lunar.js"><\/script>');</script>
    <!-- æ ·å¼ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
    <style>
        :root {
            --font-cn: "ZCOOL KuaiLe", sans-serif;
            --font-en: "Nunito", sans-serif;
            --primary: #5d6d7e;
            --accent: #d35400;
            --glass: rgba(255, 255, 255, 0.9);
            --shadow: 0 4px 15px rgba(0,0,0,0.05);
            --tab-height: 60px;
            
            /* å››åŒ–è‰² */
            --c-lu: #27ae60; --c-quan: #f39c12; --c-ke: #8e44ad; --c-ji: #c0392b;
            /* é£æ˜Ÿè‰² */
            --star-water: #2980b9; --star-earth: #d35400; --star-wood: #27ae60; --star-metal: #7f8c8d; --star-fire: #c0392b;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0;
            font-family: var(--font-cn);
            background-color: #eee;
            background-image: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            height: 100vh; overflow: hidden;
            color: #333;
        }
        .app-header {
            position: fixed; top: 0; left: 0; width: 100%; height: 50px;
            display: flex; align-items: center; padding: 0 20px; 
            padding-top: env(safe-area-inset-top);
            z-index: 100; background: rgba(255,255,255,0.6); backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.3);
        }
        .logo { font-size: 1.4rem; color: var(--primary); font-weight: bold; letter-spacing: 1px; }
        .main-viewport {
            height: 100%; width: 100%;
            padding-top: calc(50px + env(safe-area-inset-top));
            padding-bottom: calc(var(--tab-height) + env(safe-area-inset-bottom));
            overflow-y: auto; overflow-x: hidden;
            scroll-behavior: smooth;
        }
        .view-section { display: none; padding: 15px; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* æ—¥å† */
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: #fff; padding: 10px; border-radius: 12px; box-shadow: var(--shadow); }
        .cal-title { font-size: 1.2rem; font-weight: bold; color: var(--primary); }
        .btn-nav { width: 32px; height: 32px; border-radius: 50%; border: none; background: #f0f0f0; color: #555; font-size: 1rem; }
        .weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; margin-bottom: 5px; font-size: 0.9rem; color: #888; }
        .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        
        .day-cell {
            background: #fff; border-radius: 8px; aspect-ratio: 1;
            display: flex; flex-direction: column; justify-content: flex-start; align-items: center;
            position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.02); padding-top: 4px;
        }
        .day-cell.active { background: var(--primary); color: #fff; box-shadow: 0 4px 10px rgba(93, 109, 126, 0.4); border: 1px solid var(--primary); z-index: 2;}
        .day-cell.active .lunar-num, .day-cell.active .holiday, .day-cell.active .tag-chu { color: #fff !important; }
        
        .g-num { font-size: 1.1rem; font-weight: bold; line-height: 1.2; }
        .lunar-num { font-size: 0.6rem; color: #999; line-height: 1.2; }
        .holiday { font-size: 0.6rem; color: #c0392b; font-weight: bold; margin-top: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 95%; text-align: center;}
        .tag-chu { position: absolute; bottom: 2px; right: 2px; font-size: 0.5rem; background: #e74c3c; color: #fff; padding: 0 3px; border-radius: 3px; }
        .astro-box { background: #fff; padding: 15px; border-radius: 12px; margin-top: 20px; box-shadow: var(--shadow); }
        .astro-title { font-size: 1rem; font-weight: bold; color: var(--primary); margin-bottom: 10px; border-bottom: 1px dashed #eee; padding-bottom: 5px; }
        .astro-item { display: flex; gap: 10px; margin-bottom: 8px; font-size: 0.85rem; align-items: flex-start; border-bottom: 1px dashed #f5f5f5; padding-bottom: 5px;}
        .astro-date { font-weight: bold; color: var(--accent); min-width: 85px; flex-shrink: 0; }

        /* ä»Šæ—¥ */
        .big-date-box { text-align: center; margin-bottom: 20px; padding: 10px 0; }
        .bd-num { font-size: 4rem; line-height: 1; color: var(--primary); font-weight: bold; }
        .bd-lunar { font-size: 1.1rem; margin-top: 5px; color: #555; }
        .bd-gz { background: #fff; padding: 4px 12px; border-radius: 15px; display: inline-block; margin-top: 8px; font-size: 0.9rem; color: #888; border: 1px solid #eee; }

   /* ç‰¹æ®Šé”¦å›ŠæŒ‰é’® */
        .special-btn {
            width: 100%; padding: 15px; border: none; border-radius: 12px;
            background: linear-gradient(135deg, #ff9966, #ff5e62);
            color: #fff; font-size: 1.1rem; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            box-shadow: 0 4px 15px rgba(255, 94, 98, 0.3); margin-bottom: 20px;
            animation: popIn 0.5s ease;
        }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .card { background: var(--glass); border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: var(--shadow); }
        .card h3 { margin: 0 0 10px 0; font-size: 0.95rem; color: #999; text-transform: uppercase; display: flex; align-items: center; gap: 6px; border-bottom: 1px dashed #eee; padding-bottom: 8px; }
        .card h3 i { color: var(--primary); }

      
        .yiji-row { display: flex; margin-bottom: 6px; font-size: 0.95rem; line-height: 1.4; align-items: flex-start;}
        .badge { padding: 1px 6px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; margin-right: 8px; height: fit-content; white-space: nowrap; }
        .bg-yi { background: #e8f5e9; color: #27ae60; }
        .bg-ji { background: #ffebee; color: #c0392b; }
        .jianchu-info { font-size: 0.9rem; color: #555; margin-top: 8px; display: flex; gap: 10px;}
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.9rem; color: #555; }
        .info-item b { color: #333; margin-right: 5px; }

        /* Tips æ ·å¼ä¼˜åŒ– */
        .tips-box { font-size: 1rem; color: #444; line-height: 1.6; }
        .tips-hl { color: var(--accent); font-weight: bold; display: block; margin-bottom: 5px;}
        .tips-content { display: block; text-align: justify; }

        .journal-area { background: #fff; border-radius: 12px; padding: 15px; border: 1px solid #eee; }
        #journalInput { width: 100%; height: 120px; border: none; outline: none; resize: none; font-size: 1rem; line-height: 1.6; background: transparent; font-family: var(--font-cn); }

        /* æœ‰ç‚¹ç„ */
        .sihua-grid { display: grid; grid-template-columns: 50px 1fr 1fr 1fr 1fr; gap: 5px; text-align: center; font-size: 0.95rem; }
        .sh-cell { padding: 4px 0; }
        .sh-head { font-weight: bold; color: #999; font-size: 0.8rem; }
        .sh-label { font-weight: bold; color: var(--primary); text-align: left;}
        .star-txt { font-weight: bold; }
        .c-lu { color: var(--c-lu); } .c-quan { color: var(--c-quan); } .c-ke { color: var(--c-ke); } .c-ji { color: var(--c-ji); }
        .star-list-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 0.95rem; }
        .star-tag { font-weight: bold; font-size: 1rem; }
        
        .export-btn { width: 100%; padding: 15px; border: none; border-radius: 12px; background: #fff; color: var(--primary); font-size: 1rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

        .tab-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: calc(var(--tab-height) + env(safe-area-inset-bottom)); background: #fff; border-top: 1px solid #eee; display: flex; justify-content: space-around; padding-top: 8px; z-index: 99; }
        .tab-item { display: flex; flex-direction: column; align-items: center; color: #ccc; font-size: 0.7rem; transition: 0.2s; }
        .tab-item i { font-size: 1.4rem; margin-bottom: 2px; }
        .tab-item.active { color: var(--primary); }

    /* å¼¹çª— (é™æ—¶é”¦å›Š) */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f5f7fa; z-index: 2000; display: none; flex-direction: column;
            transform: translateY(100%); transition: transform 0.3s ease;
        }
        .modal.show { display: flex; transform: translateY(0); }
        .modal-header {
            padding: 15px; background: #fff; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #eee; padding-top: calc(15px + env(safe-area-inset-top));
        }
        .modal-body { flex: 1; overflow-y: auto; padding: 20px; }

        ::-webkit-scrollbar { width: 0px; background: transparent; }
        @media (max-width: 900px) {
            .app-container { flex-direction: column; height: auto; width: 100%; border-radius: 0; }
        }
    </style>
</head>
<body>

    <header class="app-header">
        <div class="logo">âœï¸ Panna</div>
    </header>

    <main class="main-viewport">
        <!-- è§†å›¾1ï¼šæ—¥å† -->
        <div id="view-cal" class="view-section active">
            <div class="calendar-header">
                <button class="btn-nav" onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                <div class="cal-title" id="calTitle">...</div>
                <button class="btn-nav" onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="weekdays"><span>æ—¥</span><span>ä¸€</span><span>äºŒ</span><span>ä¸‰</span><span>å››</span><span>äº”</span><span>å…­</span></div>
            <div class="days-grid" id="calendarGrid"></div>
            
            <div class="astro-box">
                <div class="astro-title"><i class="fas fa-star"></i> æœ¬æœˆé‡è¦å¤©è±¡</div>
                <div id="astroList"></div>
            </div>
        </div>

        <!-- è§†å›¾2ï¼šä»Šæ—¥ -->
        <div id="view-today" class="view-section">
            <div class="big-date-box">
                <div class="bd-num" id="todayDay">--</div>
                <div class="bd-lunar" id="todayLunar">åŠ è½½ä¸­...</div>
                <div class="bd-gz" id="todayGanZhi"></div>
            </div>
            
     <!-- é™æ—¶é”¦å›Šå…¥å£ (åŠ¨æ€æ˜¾ç¤º) -->
            <div id="specialEventContainer" style="display:none;">
                <button class="special-btn" onclick="openSpecialModal()">
                    <i class="fas fa-envelope-open-text"></i> <span id="specialEventTitle"></span>
                </button>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-scroll"></i> æœ¬æ—¥å®œå¿Œ</h3>
                <div class="yiji-row">
                    <span class="badge bg-yi">å®œ</span> <span id="todayYi"></span>
                </div>
                <div class="yiji-row">
                    <span class="badge bg-ji">å¿Œ</span> <span id="todayJi"></span>
                </div>
                <div class="jianchu-info">
                    <span>å»ºé™¤ï¼š<b id="todayJianChu" style="color:var(--accent)"></b></span>
                                </div>
            </div>

            <div class="card">
                <h3><i class="fas fa-bolt"></i> èƒ½é‡æ–¹ä½</h3>
                <div class="info-grid">
                    <div class="info-item"><span>è´¢ç¥</span> <b id="godCai"></b></div>
                    <div class="info-item"><span>å–œç¥</span> <b id="godXi"></b></div>
                    <div class="info-item"><span>ç¦ç¥</span> <b id="godFu"></b></div>
                    <div class="info-item"><span>å†²ç…</span> <b id="chongSha"></b></div>
                </div>
            </div>

            <div class="card">
                <h3><i class="fas fa-lightbulb"></i> æ¯æ—¥Tips</h3>
                <div class="tips-box" id="todayAdvice"></div>
            </div>

            <div class="card">
                <h3><i class="fas fa-pen"></i> å¿ƒæƒ…éšè®°</h3>
                <div class="journal-area">
                    <textarea id="journalInput" placeholder="è®°å½•å½“ä¸‹çš„æƒ³æ³•... (è‡ªåŠ¨ä¿å­˜)"></textarea>
                </div>
            </div>
        </div>

        <!-- è§†å›¾3ï¼šæœ‰ç‚¹ç„ -->
        <div id="view-pro" class="view-section">
            <h2 style="margin-bottom:20px; color:var(--primary);">æœ‰ç‚¹ç„</h2>
            
            <div class="card">
                <h3><i class="fas fa-th"></i> ä¹å®«é£æ˜Ÿ</h3>
                <div id="fsList"></div>
            </div>

            <div class="card">
                <h3><i class="fas fa-bahai"></i> ç´«å¾®å››åŒ–</h3>
                <div class="sihua-grid">
                    <div class="sh-cell"></div>
                    <div class="sh-cell sh-head" style="color:var(--c-lu)">â— ç¦„</div>
                    <div class="sh-cell sh-head" style="color:var(--c-quan)">â— æƒ</div>
                    <div class="sh-cell sh-head" style="color:var(--c-ke)">â— ç§‘</div>
                    <div class="sh-cell sh-head" style="color:var(--c-ji)">â— å¿Œ</div>
                    <div style="display:contents" id="sihuaContent"></div>
                </div>
            </div>

            <div class="card">
                <h3><i class="fas fa-database"></i> æ•°æ®ç®¡ç†</h3>
                <button class="export-btn" onclick="exportJournal()">
                    <i class="fas fa-file-export"></i> å¯¼å‡ºæˆ‘çš„æ—¥è®° (TXT)
                </button>
            </div>
        </div>

    </main>
    <nav class="tab-bar">
        <div class="tab-item active" onclick="switchTab('view-cal', this)">
            <i class="fas fa-calendar-alt"></i> <span>æ—¥å†</span>
        </div>
        <div class="tab-item" onclick="switchTab('view-today', this)">
            <i class="fas fa-sun"></i> <span>ä»Šæ—¥</span>
        </div>
        <div class="tab-item" onclick="switchTab('view-pro', this)">
            <i class="fas fa-yin-yang"></i> <span>æœ‰ç‚¹ç„</span>
        </div>
    </nav>

    <!-- å¼¹çª—ï¼šé™æ—¶é”¦å›Š -->
    <div id="specialModal" class="modal">
        <div class="modal-header">
            <button onclick="closeSpecialModal()" style="border:none; background:none; font-size:1.5rem; color:#d35400">&times;</button>
            <h3 style="margin:0; color:#d35400" id="spModalTitle"></h3>
            <div style="width:20px"></div>
        </div>

        <div class="modal-body">
            <div id="spModalContent" style="font-size:1.05rem; line-height:1.8; color:#444;"></div>
        </div>
    </div>
    
    <script>
        let currentDate = new Date();
        let selectedDate = new Date();
        const monthNames = ["1æœˆ","2æœˆ","3æœˆ","4æœˆ","5æœˆ","6æœˆ","7æœˆ","8æœˆ","9æœˆ","10æœˆ","11æœˆ","12æœˆ"];

// ç‰¹å®šå¹´ä»½çš„Tips
const CUSTOM_TIPS = {
  "2025-12-07": "ä»Šæ—¥å¤§é›ªï¼Œå¼€å¯æˆŠå­æœˆï¼Œæ¬²æœ›æ‰©å¼ ï¼ŒæŠ•æœºå¨±ä¹æ´»è·ƒã€‚éœ€è­¦æƒ•è®¡åˆ’èµ¶ä¸ä¸Šå˜åŒ–ï¼Œäº¤é€šé€šè®¯æˆ–ç§‘æŠ€å‘å±•å—é˜»ã€‚",
  "2025-12-09": "ä»Šæ—¥éœ€è¦åŠ¡å®å’Œé¢å¯¹ç°å®çš„è€ƒéªŒã€‚æƒ…ç»ªå¯èƒ½ä½è½ï¼Œæ™®éæ„Ÿåˆ°â€œæ¯å­åŠç©ºâ€ã€‚",
  "2025-12-10": "æµ·ç‹æ˜Ÿé¡ºè¡Œï¼Œ çµæ€§ã€åŒæƒ…å¿ƒå¢å¼ºï¼Œä½†ä¹Ÿææ˜“äº§ç”Ÿâ€œå¹»æƒ³å’Œéª—å±€â€ã€‚éœ€è¦è¿›è¡Œç°å®æ£€éªŒï¼Œè­¦æƒ•è™šå‡ä¿¡æ¯ã€‚æ°´æ˜Ÿå¯¹å†²å¤©ç‹æ˜Ÿï¼Œå†³å®šæ€§çš„ã€é¢ è¦†æ€§çš„æ¶ˆæ¯æˆ–äº‹ä»¶å°†å‡ºç°ã€‚æ­¤ç›¸ä½ä¸ç¾å›½å›½å®¶æ˜Ÿç›˜çš„æœˆäº®ç´§å¯†ç›¸å…³ï¼Œå¯èƒ½è§¦å‘å…¶å›½å†…çš„æŒç»­åŠ¨è¡ä¸å˜é©ã€‚",
  "2025-12-14": "ç«æ˜Ÿåˆ‘å…‹æµ·ç‹æ˜Ÿï¼Œè¡ŒåŠ¨éœ€è°¨æ…ï¼Œé¿å…å› ä»“ä¿ƒè¡Œäº‹è€ŒçŠ¯é”™ã€‚",
  "2025-12-15": "ç«æ˜Ÿè¿›å…¥é­”ç¾¯åº§ï¼Œåœ¨æœªæ¥å…­å‘¨ä¸ºæ‘©ç¾¯åº§æ³¨å…¥åŠ¨åŠ›å’Œèƒ½é‡ï¼Œå¸®åŠ©å…¶é‡‡å–è¡ŒåŠ¨ï¼Œä½†ä¹Ÿå¯èƒ½åœ¨ä¸ªäººç”Ÿæ´»ä¸­å¼•å‘å†²çªã€‚",
  "2025-12-17": "å¤ªé˜³åˆ‘å…‹åœŸæ˜Ÿï¼Œåœ¨èŠ‚æ—¥å‰å¸¦æ¥åˆä¸€æ¬¡ç°å®çš„è€ƒéªŒï¼Œè®©äººå›å½’ç°å®ï¼Œæƒ…ç»ªå¯èƒ½è¾ƒä¸ºæ²‰é‡ã€‚"
};

// é€‚ç”¨äºæ‰€æœ‰å¹´ä»½çš„Tips
const RECURRING_TIPS = {
    "01-01": "ğŸ‰ å…ƒæ—¦å¿«ä¹ï¼æ–°çš„ä¸€å¹´ï¼Œæ–°çš„å¼€å§‹ï¼Œæ„¿ä½ ä¸‡äº‹å¦‚æ„ï¼",
    "02-14": "â¤ï¸ Happy Valentine's Day!",
    "05-20": "â¤ï¸ 520 Special: Love is in the air!",
    "06-01": "ğŸˆ Children's Day: Keep your inner child alive.",
    "12-25": "ğŸ„ åœ£è¯å¿«ä¹ï¼Œå®œæ¸©é¦¨ç›¸èšã€‚"ï¼Œ
    "12-31": "ğŸ¥‚ å¹´æœ«å€’æ•°ï¼æ„Ÿæ©è¿‡å»ä¸€å¹´çš„æ‰€æœ‰ç›¸é‡ï¼ŒæœŸå¾…å…¨æ–°çš„å¼€å§‹ã€‚"
};
        
        // === 2025-2028 æ˜Ÿè±¡åº“ (User Data) ===
        const AstroDB = {
            "2025-2": [{d:24,t:"é‡‘æ˜Ÿé€†è¡Œå¼€å§‹"}], 
            "2025-3": [{d:14,t:"æœˆå…¨é£Ÿ(åŒé±¼)"},{d:15,t:"æ°´é€†å¼€å§‹"},{d:29,t:"æ—¥å…¨é£Ÿ(å¤„å¥³)"},{d:30,t:"æµ·ç‹æ˜Ÿè¿›ç™½ç¾Š"}],
            "2025-4": [{d:7,t:"æ°´æ˜Ÿé¡ºè¡Œ"},{d:13,t:"é‡‘æ˜Ÿé¡ºè¡Œ"}],
            "2025-5": [{d:4,t:"å†¥ç‹æ˜Ÿé€†è¡Œå¼€å§‹"},{d:25,t:"åœŸæ˜Ÿè¿›ç™½ç¾Š"}],
            "2025-6": [{d:10,t:"æœ¨æ˜Ÿè¿›å·¨èŸ¹"}],
            "2025-7": [{d:4,t:"æµ·ç‹æ˜Ÿé€†è¡Œå¼€å§‹"},{d:7,t:"å¤©ç‹æ˜Ÿè¿›åŒå­"},{d:13,t:"åœŸæ˜Ÿé€†è¡Œå¼€å§‹"},{d:18,t:"æ°´é€†å¼€å§‹"}],
            "2025-8": [{d:11,t:"æ°´æ˜Ÿé¡ºè¡Œ"},{d:30,t:"å¤©ç‹æ˜Ÿé€†è¡Œå¼€å§‹"}],
            "2025-9": [{d:1,t:"åœŸæ˜Ÿé€†å›åŒé±¼"},{d:7,t:"æ—¥åé£Ÿ(åŒé±¼)"},{d:21,t:"æœˆåé£Ÿ(æ‘©ç¾¯)"}],
            "2025-10": [{d:9,t:"æœ¨æ˜Ÿé€†è¡Œå¼€å§‹"},{d:14,t:"å†¥ç‹æ˜Ÿé¡ºè¡Œ"}],
            "2025-11": [{d:9,t:"æ°´é€†å¼€å§‹"},{d:28,t:"åœŸæ˜Ÿé¡ºè¡Œ"},{d:29,t:"æ°´æ˜Ÿé¡ºè¡Œ"}],
            "2026-1": [{d:29,t:"å¤©ç‹æ˜Ÿé¡ºè¡Œ"}],
            "2026-2": [{d:4,t:"æœ¨æ˜Ÿé¡ºè¡Œ"},{d:17,t:"æ—¥ç¯é£Ÿ(æ°´ç“¶)"},{d:26,t:"æ°´é€†å¼€å§‹"}],
            "2026-3": [{d:3,t:"æœˆå…¨é£Ÿ(ç‹®å­)"},{d:20,t:"æ°´æ˜Ÿé¡ºè¡Œ"}],
            "2026-5": [{d:6,t:"å†¥ç‹æ˜Ÿé€†è¡Œå¼€å§‹"}],
            "2026-6": [{d:20,t:"æœ¨æ˜Ÿè¿›ç‹®å­"},{d:29,t:"æ°´é€†å¼€å§‹"}],
            "2026-7": [{d:6,t:"æµ·ç‹æ˜Ÿé€†è¡Œå¼€å§‹"},{d:23,t:"æ°´æ˜Ÿé¡ºè¡Œ"},{d:26,t:"åœŸæ˜Ÿé€†è¡Œå¼€å§‹"}],
            "2026-8": [{d:12,t:"æ—¥å…¨é£Ÿ(ç‹®å­)"},{d:28,t:"æœˆåé£Ÿ(æ°´ç“¶)"}],
            "2026-9": [{d:2,t:"åœŸæ˜Ÿé€†å›åŒé±¼"},{d:4,t:"å¤©ç‹æ˜Ÿé€†è¡Œå¼€å§‹"}],
            "2026-10": [{d:16,t:"å†¥ç‹æ˜Ÿé¡ºè¡Œ"},{d:24,t:"æ°´é€†å¼€å§‹"}],
            "2026-11": [{d:8,t:"å¤©ç‹æ˜Ÿé€†å›é‡‘ç‰›"},{d:13,t:"æ°´æ˜Ÿé¡ºè¡Œ"}],
            "2026-12": [{d:11,t:"åœŸæ˜Ÿé¡ºè¡Œ"},{d:12,t:"æµ·ç‹æ˜Ÿé¡ºè¡Œ"}],
            "2027-2": [{d:3,t:"å¤©ç‹æ˜Ÿé¡ºè¡Œ"},{d:6,t:"æ—¥ç¯é£Ÿ(æ°´ç“¶)"},{d:9,t:"æ°´é€†å¼€å§‹"},{d:20,t:"æœˆåé£Ÿ(å¤„å¥³)"},{d:20,t:"ç«æ˜Ÿé€†è¡Œå¼€å§‹"}],
            "2027-3": [{d:3,t:"æ°´æ˜Ÿé¡ºè¡Œ"},{d:8,t:"æœˆåé£Ÿ(åŒé±¼)"},{d:23,t:"æœ¨æ˜Ÿé€†è¡Œå¼€å§‹"}],
            "2027-4": [{d:26,t:"å¤©ç‹æ˜Ÿé¡ºè¡Œè¿›åŒå­"}],
            "2027-5": [{d:8,t:"å†¥ç‹æ˜Ÿé€†è¡Œå¼€å§‹"},{d:11,t:"ç«æ˜Ÿé¡ºè¡Œ"}],
            "2027-6": [{d:10,t:"æ°´é€†å¼€å§‹"}],
            "2027-7": [{d:4,t:"æ°´æ˜Ÿé¡ºè¡Œ"},{d:8,t:"æµ·ç‹æ˜Ÿé€†è¡Œå¼€å§‹"},{d:13,t:"æœ¨æ˜Ÿè¿›å¤„å¥³"},{d:26,t:"æœ¨æ˜Ÿé¡ºè¡Œ"}],
            "2027-8": [{d:2,t:"æ—¥å…¨é£Ÿ(ç‹®å­)"},{d:9,t:"åœŸæ˜Ÿé€†è¡Œå¼€å§‹"},{d:17,t:"æœˆå…¨é£Ÿ(åŒé±¼)"}],
            "2027-9": [{d:9,t:"å¤©ç‹æ˜Ÿé€†è¡Œå¼€å§‹"}],
            "2027-10": [{d:7,t:"æ°´é€†å¼€å§‹"},{d:18,t:"å†¥ç‹æ˜Ÿé¡ºè¡Œ"},{d:28,t:"æ°´æ˜Ÿé¡ºè¡Œ"}],
            "2027-12": [{d:14,t:"æµ·ç‹æ˜Ÿé¡ºè¡Œ"},{d:24,t:"åœŸæ˜Ÿé¡ºè¡Œ"}],
            "2028-1": [{d:1,t:"å†¥ç‹/ç«æ˜Ÿè¿›æ°´ç“¶"},{d:12,t:"æœˆåé£Ÿ(å·¨èŸ¹)/æœ¨æ˜Ÿé€†è¡Œå¼€å§‹"},{d:24,t:"æ°´é€†å¼€å§‹"},{d:26,t:"æ—¥ç¯é£Ÿ(æ°´ç“¶)"}],
            "2028-2": [{d:8,t:"å¤©ç‹æ˜Ÿé¡ºè¡Œ"},{d:14,t:"æ°´æ˜Ÿé¡ºè¡Œ"}],
            "2028-5": [{d:1,t:"å†¥ç‹æ˜Ÿé€†è¡Œ"},{d:14,t:"æœ¨æ˜Ÿé¡ºè¡Œ"},{d:21,t:"æ°´é€†å¼€å§‹"}],
            "2028-6": [{d:14,t:"æ°´æ˜Ÿé¡ºè¡Œ"}],
            "2028-7": [{d:1,t:"æµ·ç‹æ˜Ÿé€†è¡Œ"},{d:6,t:"æœˆåé£Ÿ(æ‘©ç¾¯)"},{d:22,t:"æ—¥å…¨é£Ÿ(å·¨èŸ¹)"}],
            "2028-8": [{d:1,t:"æœ¨æ˜Ÿè¿›å¤©ç§¤"},{d:23,t:"åœŸæ˜Ÿé€†è¡Œå¼€å§‹"}],
            "2028-9": [{d:19,t:"æ°´é€†å¼€å§‹"}],
            "2028-10": [{d:11,t:"æ°´æ˜Ÿé¡ºè¡Œ"}],
            "2028-12": [{d:31,t:"æœˆå…¨é£Ÿ(å·¨èŸ¹)"}]
        };

        // åå¤©å¹²å››åŒ–ä¸ç¤¾ä¼šè¶‹åŠ¿è§£è¯»
        const SiHuaTips = {
            "ç”²": "å»‰è´åŒ–ç¦„ (æœºé‡)ã€ç ´å†›åŒ–æƒ (æƒåŠ›)ã€æ­¦æ›²åŒ–ç§‘ (å£°æœ›)ã€å¤ªé˜³åŒ–å¿Œ (é—®é¢˜)ã€‚<br>è¶‹åŠ¿ï¼šæ—§ç§©åºå˜é©ï¼Œå…³æ³¨æ³•å¾‹ä¸æ”¿æ²»æ–°æœºä¼šã€‚å¤§åˆ€é˜”æ–§çš„æ”¹é©æŒæƒã€‚éœ€è­¦æƒ•ç”·æ€§é¢†è¢–æˆ–å…¬ä¿¡åŠ›å—æŸã€‚",
            "ä¹™": "å¤©æœºåŒ–ç¦„ã€å¤©æ¢åŒ–æƒã€ç´«å¾®åŒ–ç§‘ã€å¤ªé˜´åŒ–å¿Œã€‚<br>è¶‹åŠ¿ï¼šæ™ºæ…§åšå¼ˆï¼Œåˆ©äºç­–åˆ’ç§‘æŠ€ä¸æ…ˆå–„ç›‘ç®¡ã€‚å¥³æ€§é¢†è¢–æˆ–æ°‘ç”Ÿæˆ¿äº§é¢†åŸŸå¯èƒ½å‡ºç°ç„¦è™‘æˆ–åŠ¨è¡ã€‚",
            "ä¸™": "å¤©åŒåŒ–ç¦„ã€å¤©æœºåŒ–æƒã€æ–‡æ˜ŒåŒ–ç§‘ã€å»‰è´åŒ–å¿Œã€‚<br>è¶‹åŠ¿ï¼šäº«ä¹æœåŠ¡ä¸šå…´ç››ï¼Œåˆ©äºæ–‡åŒ–ç­¾çº¦ã€‚éœ€è­¦æƒ•æ³•å¾‹çº çº·ã€ç§©åºæ··ä¹±åŠæƒ…æ„Ÿçº çº·ã€‚",
            "ä¸": "å¤ªé˜´åŒ–ç¦„ã€å¤©åŒåŒ–æƒã€å¤©æœºåŒ–ç§‘ã€å·¨é—¨åŒ–å¿Œã€‚<br>è¶‹åŠ¿ï¼šæ°‘ç”Ÿæ¶ˆè´¹ä¸å¥³æ€§äº§ä¸šåˆ©å¥½ã€‚éœ€è­¦æƒ•å£èˆŒæ˜¯éã€ç½‘ç»œè°£è¨€åŠæš—å¤„çš„é—®é¢˜çˆ†å‘ã€‚",
            "æˆŠ": "è´ªç‹¼åŒ–ç¦„ã€å¤ªé˜´åŒ–æƒã€å³å¼¼åŒ–ç§‘ã€å¤©æœºåŒ–å¿Œã€‚<br>è¶‹åŠ¿ï¼šæ¬²æœ›æ‰©å¼ ï¼ŒæŠ•æœºå¨±ä¹æ´»è·ƒã€‚éœ€è­¦æƒ•è®¡åˆ’èµ¶ä¸ä¸Šå˜åŒ–ï¼Œäº¤é€šé€šè®¯æˆ–ç§‘æŠ€å‘å±•å—é˜»ã€‚",
            "å·±": "æ­¦æ›²åŒ–ç¦„ã€è´ªç‹¼åŒ–æƒã€å¤©æ¢åŒ–ç§‘ã€æ–‡æ›²åŒ–å¿Œã€‚<br>è¶‹åŠ¿ï¼šåŠ¡å®æ±‚è´¢ï¼Œå•†ä¸šç«äº‰æ¿€çƒˆã€‚éœ€è­¦æƒ•æ–‡ä¹¦åˆçº¦å‡ºé”™ï¼Œé¿å…éç†æ€§çš„æƒ…æ„Ÿæ³›æ»¥ã€‚",
            "åºš": "å¤ªé˜³åŒ–ç¦„ã€æ­¦æ›²åŒ–æƒã€å¤ªé˜´åŒ–ç§‘ã€å¤©åŒåŒ–å¿Œã€‚<br>è¶‹åŠ¿ï¼šæƒå¨ä¸å®ä¸šåŠ›é‡åŠ å¼ºï¼Œåˆ©äºå…¬ç”¨äº‹ä¸šã€‚éœ€è­¦æƒ•ç¦æ°”å—æŸï¼Œç¤¾ä¼šæƒ…ç»ªå®¹æ˜“ä½è½èººå¹³ã€‚",
            "è¾›": "å·¨é—¨åŒ–ç¦„ã€å¤ªé˜³åŒ–æƒã€æ–‡æ›²åŒ–ç§‘ã€æ–‡æ˜ŒåŒ–å¿Œã€‚<br>è¶‹åŠ¿ï¼šåˆ©äºå£æ‰ä¸å’¨è¯¢ä¸šï¼Œæƒå¨å¼ºåŒ–ã€‚éœ€è­¦æƒ•é‡å¤§åˆçº¦ã€æ³•å¾‹æ–‡ä»¶æˆ–åˆ¶åº¦è§„åˆ™å‡ºç°æ¼æ´ã€‚",
            "å£¬": "å¤©æ¢åŒ–ç¦„ã€ç´«å¾®åŒ–æƒã€å·¦è¾…åŒ–ç§‘ã€æ­¦æ›²åŒ–å¿Œã€‚<br>è¶‹åŠ¿ï¼šåˆ©äºåŒ»ç–—æ…ˆå–„ä¸ä¼ ç»Ÿæ–‡åŒ–ï¼Œé¢†å¯¼æƒåŠ›è¾¾é¡¶å³°ã€‚éœ€è­¦æƒ•é‡‘èæ³¢åŠ¨ï¼Œè´¢æ˜Ÿå—æŸï¼Œæ…é‡ç†è´¢ã€‚",
            "ç™¸": "ç ´å†›åŒ–ç¦„ã€å·¨é—¨åŒ–æƒã€å¤ªé˜´åŒ–ç§‘ã€è´ªç‹¼åŒ–å¿Œã€‚<br>è¶‹åŠ¿ï¼šç ´æ—§ç«‹æ–°ï¼Œé¢ è¦†æ€§åˆ›æ–°ä¸ºä¸»ã€‚éœ€è­¦æƒ•æŠ•æœºæ³¡æ²«ç ´è£‚ï¼Œç†æƒ³ä¸»ä¹‰å¹»ç­ã€‚"
        };

  // é”¦å›Šåº“
        const TimeCapsules = [
            {
                id: "bingwu_2026",
                start: "12-21", end: "12-31", year: 2025,
                title: "ğŸ”¥ 2026ä¸™åˆå¹´è¿ç¨‹å‰ç»",
                content: `<div style="text-align:center;margin-bottom:15px;"><h2 style="color:#c0392b">ä¸™åˆå¤©æ²³æ°´</h2><p style="color:#666">ç«æ°”æœ€æ—ºçš„ä¸€å¹´ï¼Œé‡åœ¨ä¿®å¿ƒ</p></div><p><b>é‡ç‚¹æç¤ºï¼š</b><br>1.ç”Ÿè‚–å‰å‡¶ï¼šæœ¬å¹´å±é©¬ï¼ˆå€¼å¤ªå²ã€åˆ‘å¤ªå²ï¼‰ã€é¼ ï¼ˆå†²å¤ªå²ï¼‰ã€ç‰›ï¼ˆå®³å¤ªå²ï¼‰ã€å…”ï¼ˆç ´å¤ªå²ï¼‰ã€é¸¡ï¼ˆåˆ‘å¤ªå²ï¼‰ï¼Œå±è™ï¼Œç‹—å…­åˆã€‚<br>2.ç´«å¾®æ–—æ•°ï¼šä¸™å¹´å¤©åŒåŒ–ç¦„ã€å¤©æœºåŒ–æƒã€æ–‡æ˜ŒåŒ–ç§‘ã€å»‰è´åŒ–å¿Œï¼Œäº«ä¹æœåŠ¡ä¸šå…´ç››ï¼Œåˆ©äºæ–‡åŒ–ç­¾çº¦ã€‚éœ€è­¦æƒ•æ³•å¾‹çº çº·ã€ç§©åºæ··ä¹±åŠæƒ…æ„Ÿçº çº·ã€‚<br>3. é£æ°´å¸ƒå±€ï¼šå‰æ–¹ - æ­£ä¸œæ–¹ï¼ˆæ­£è´¢ä½ï¼‰ï¼Œä¸œå—æ–¹ï¼ˆå§»ç¼˜ä½ï¼‰ï¼Œä¸­å®«ï¼ˆäººç¼˜æ¡ƒèŠ±ä½ï¼‰ï¼Œä¸œåŒ—æ–¹ï¼ˆæ–‡æ˜Œä½ï¼‰ï¼›å‡¶æ–¹ - æ­£å—æ–¹ï¼ˆå¤ªå²æ–¹åŠäº”é»„ç…ï¼‰ï¼Œå®œä¿æŒå¹²å‡€æ•´æ´ï¼Œåˆ‡å¿ŒåŠ¨åœŸã€‚è¥¿åŒ—æ–¹ï¼ˆç—…ç¬¦ä½ï¼‰ï¼Œå®œæ‘†æ”¾é“œè‘«èŠ¦åŒ–è§£ã€‚</p>`
            }
        ];


        const ModernEvents = ["å‡ºè¡Œ","çº³è´¢","å…¥å®…","å«å¨¶","äº¤æ˜“","ä¼šå‹","ç­¾çº¦","è£…ä¿®","æ¬å®¶","ç¥ˆç¦","å¼€å¸‚","åŠ¨åœŸ","ç½®äº§","å®‰åºŠ","ç†å‘","æ±‚åŒ»"];
        
        const bgImages = [
            "https://images.unsplash.com/photo-1549887534-1541e9326642?q=80&w=1000", 
            "https://images.unsplash.com/photo-1541963463532-d68292c34b19?q=80&w=1000", 
            "https://images.unsplash.com/photo-1578301978693-85fa9c0320b9?q=80&w=1000", 
            "https://images.unsplash.com/photo-1577083552431-6e5fd01aa342?q=80&w=1000", 
            "https://images.unsplash.com/photo-1547891654-e66ed7ebb968?q=80&w=1000", 
            "https://images.unsplash.com/photo-1549490349-8643362247b5?q=80&w=1000", 
            "https://images.unsplash.com/photo-1550684848-fac1c5b4e853?q=80&w=1000", 
            "https://images.unsplash.com/photo-1578320339912-5893539047ae?q=80&w=1000", 
            "https://images.unsplash.com/photo-1558591710-4b4a1ae0f04d?q=80&w=1000", 
            "https://images.unsplash.com/photo-1507646227500-4d389b0012be?q=80&w=1000", 
            "https://images.unsplash.com/photo-1544716278-ca5e3f4abd8c?q=80&w=1000", 
            "https://images.unsplash.com/photo-1604147706283-d7119b5b7636?q=80&w=1000"
        ];
        const seasonColors = ["#8d99ae", "#ffb7b2", "#a8e6cf", "#95d5b2", "#ff9f1c", "#48cae4", "#ff6b6b", "#e07a5f", "#d4a373", "#457b9d", "#d62828", "#bc4749"];
  
      
        
        // === åˆå§‹åŒ– ===
        window.onload = function() {
            if(typeof Lunar === 'undefined') { alert("æ ¸å¿ƒç»„ä»¶åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ"); return; }
            renderHome();
            document.getElementById('journalInput').addEventListener('input', function(){
                localStorage.setItem('panna_j_'+getDateKey(selectedDate), this.value);
            });
        };
        function switchTab(viewId, btn) {
            document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            document.querySelectorAll('.tab-item').forEach(e => e.classList.remove('active'));
            btn.classList.add('active');
        }
        function renderHome() {
            updateTheme();
            renderCalendar();
            updateDetails(selectedDate);
            renderAstroEvents();
        }
        function changeMonth(n) {
            currentDate.setMonth(currentDate.getMonth() + n);
            renderHome();
        }
        function updateTheme() {
            const m = currentDate.getMonth();
            document.body.style.backgroundImage = `url('${bgImages[m]}')`;
            document.documentElement.style.setProperty('--season-accent', seasonColors[m]);
        }
        function renderCalendar() {
            const y = currentDate.getFullYear();
            const m = currentDate.getMonth();
            document.querySelector('.cal-title').innerText = `${y}å¹´ ${m+1}æœˆ`;
            
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            const firstDay = new Date(y, m, 1).getDay();
            const days = new Date(y, m+1, 0).getDate();
            for(let i=0; i<firstDay; i++) grid.innerHTML += `<div></div>`;
            for(let i=1; i<=days; i++) {
                const d = new Date(y, m, i);
                const l = Lunar.fromDate(d);
                const isSel = d.toDateString() === selectedDate.toDateString();
                
                let txt = l.getDayInChinese();
                let cls = "";
                let tag = "";
                const fs = l.getFestivals();
                const jq = l.getJieQi();
                const major = ["æ˜¥èŠ‚","å…ƒå®µèŠ‚","ç«¯åˆèŠ‚","ä¸ƒå¤•èŠ‚","ä¸­ç§‹èŠ‚","é‡é˜³èŠ‚","é™¤å¤•","å›½åº†èŠ‚","åŠ³åŠ¨èŠ‚","å…ƒæ—¦"];
                
                if(fs.length && major.includes(fs[0])) { 
                    tag = `<div class="holiday">${fs[0]}</div>`; txt = ""; 
                } else if (jq) {
                    tag = `<div class="holiday" style="color:#d35400">${jq}</div>`; txt = "";
                } else if(txt==='åˆä¸€'||txt==='åäº”') {
                    cls = "gold";
                }
                
                if(l.getZhiXing() === 'é™¤') tag += `<div class="tag-chu">é™¤</div>`;
                const div = document.createElement('div');
                div.className = `day-cell ${isSel?'active':''}`;
                div.innerHTML = `<span class="g-num">${i}</span><span class="lunar-num ${cls}">${txt}</span>${tag}`;
                div.onclick = () => { 
                    selectedDate = d; renderCalendar(); updateDetails(d); 
                    switchTab('view-today', document.querySelectorAll('.tab-item')[1]); 
                };
                grid.appendChild(div);
            }
        }
        function updateDetails(date) {
            try {
                const l = Lunar.fromDate(date);
                
                document.getElementById('todayDay').innerText = date.getDate();
                document.getElementById('todayLunar').innerText = `å†œå† ${l.getMonthInChinese()}æœˆ${l.getDayInChinese()}`;
                document.getElementById('todayGanZhi').innerText = `${l.getYearInGanZhi()}å¹´ ${l.getMonthInGanZhi()}æœˆ ${l.getDayInGanZhi()}æ—¥`;
                const yi = l.getDayYi().filter(x=>ModernEvents.includes(x));
                const ji = l.getDayJi().filter(x=>ModernEvents.includes(x));
                document.getElementById('todayYi').innerText = yi.length ? yi.join(' ') : "å¹³";
                document.getElementById('todayJi').innerText = ji.length ? ji.join(' ') : "å¹³";
                
                document.getElementById('todayJianChu').innerText = l.getZhiXing();
                document.getElementById('godCai').innerText = mapDir(l.getDayPositionCai());
                document.getElementById('godXi').innerText = mapDir(l.getDayPositionXi());
                document.getElementById('godFu').innerText = mapDir(l.getDayPositionFu());
                document.getElementById('chongSha').innerText = `å†²${l.getDayChongDesc()} ç…${mapDir(l.getDaySha())}`;
                
                // === æ™ºèƒ½ Tips ç”Ÿæˆé€»è¾‘ (æœ‰ä¼˜å…ˆçº§) ===
                const y = date.getFullYear();
                const m = String(date.getMonth() + 1).padStart(2, '0');
                const d = String(date.getDate()).padStart(2, '0');
                let tip = "";

                // ä¼˜å…ˆçº§1: æ¯å¹´å¾ªç¯çš„Tips
                const recurringTipKey = `${m}-${d}`;
                tip = RECURRING_TIPS[recurringTipKey] || "";

                // ä¼˜å…ˆçº§2: ç‰¹å®šæ—¥æœŸçš„Tips (å¦‚æœæ²¡æ‰¾åˆ°å¾ªç¯Tip)
                if (!tip) {
                    const customTipKey = `${y}-${m}-${d}`;
                    tip = CUSTOM_TIPS[customTipKey] || "";
                }

                const fs = l.getFestivals();
                const k = `${date.getFullYear()}-${date.getMonth()+1}`;
                
                // ä¼˜å…ˆçº§3: èŠ‚æ—¥ç¥ç¦
                if(!tip && fs.length) {
                    const f = fs[0];
                    if(f==="æ˜¥èŠ‚") tip = "ğŸ§¨ æ˜¥èŠ‚å¿«ä¹ï¼æ„¿æ–°çš„ä¸€å¹´ä¸‡äº‹é¡ºé‚ï¼Œå¹³å®‰å–œä¹ã€‚";
                    else if(f==="å…ƒå®µèŠ‚") tip = "ğŸ® å…ƒå®µå¿«ä¹ï¼æ„¿ç”Ÿæ´»åœ†æ»¡ï¼Œå‰é€”æ˜äº®ã€‚";
                    else if(f==="æ¸…æ˜èŠ‚") tip = "æ¸…æ˜è‡³ï¼Œç¥­å…ˆç¥–;æºå®¶äººï¼Œå»æ‰«å¢“ã€‚æŸ³è‰²æ–°ï¼Œæ˜¥è«è´Ÿ;å¤šä¿é‡ï¼Œæƒ…å¦‚æ•…ã€‚";
                    else if(f==="ç«¯åˆèŠ‚") tip = "ğŸ² ç«¯åˆå®‰åº·ï¼æ„¿æ‚¨ç™¾æ¯’ä¸ä¾µï¼Œè¯¸é‚ªé€€æ•£ã€‚";
                    else if(f==="ä¸­ç§‹èŠ‚") tip = "ğŸ¥® ä¸­ç§‹å¿«ä¹ï¼æ„¿èŠ±å¥½æœˆåœ†ï¼Œäººæœˆä¸¤å›¢åœ†ã€‚";
                     else if(f==="é‡é˜³èŠ‚") tip = "å²å²é‡é˜³ï¼Œä»Šåˆé‡é˜³ï¼Œä¸ä¼¼æ˜¥å…‰ï¼Œèƒœä¼¼æ˜¥å…‰ã€‚";    
                    else if(f==="é™¤å¤•") tip = "ğŸ§§ è¾æ—§è¿æ–°ï¼Œæ„¿æ‚¨æ‰«é™¤çƒ¦æ¼ï¼Œè¿æ¥ç¾å¥½ã€‚";
                    else tip = `ğŸ‰ ä»Šå¤©æ˜¯${f}ï¼Œç¥æ‚¨èŠ‚æ—¥å¿«ä¹ï¼`;
                }
                // ä¼˜å…ˆçº§4: æ˜Ÿè±¡æç¤º
                if(!tip && AstroDB[k]) {
                    const dayNum = date.getDate();
                    const evt = AstroDB[k].find(e => {
                        if(typeof e.d === 'number') return e.d === dayNum;
                        if(typeof e.d === 'string') return parseInt(e.d) === dayNum;
                        return false;
                    });
                    if(evt) {
                        const t = evt.t;
                        if(t.includes("è¿›å…¥")) tip = `ğŸŒŒ ${t}ï¼šè¡Œæ˜Ÿè½¬æ¢è·‘é“ï¼Œå¼€å¯æ–°çš„èƒ½é‡è¯¾é¢˜ã€‚`;
                        else if(t.includes("é€†è¡Œ")) tip = `ğŸ’« ${t}ï¼šåæ€ã€å›é¡¾ä¸ä¿®æ­£çš„æ—¶æœŸï¼Œæ”¾æ…¢è„šæ­¥ã€‚`;
                        else if(t.includes("é£Ÿ")) tip = `ğŸŒ‘ ${t}ï¼šèƒ½é‡å¼ºå¤§çš„è½¬æŠ˜ç‚¹ï¼Œå‘½è¿çš„é½¿è½®å¼€å§‹è½¬åŠ¨ã€‚`;
                        else if(t.includes("é¡ºè¡Œ")) tip = `âœ… ${t}ï¼šé˜»ç¢æ¶ˆæ•£ï¼Œèƒ½é‡æ¢å¤é¡ºç•…ï¼Œé€‚å®œæ¨è¿›è®¡åˆ’ã€‚`;
                        else tip = `ğŸ’¡ æ˜Ÿè±¡æç¤ºï¼š${t}`;
                    }
                }
                // ä¼˜å…ˆçº§5: æµæœˆå››åŒ– (åˆä¸€æ˜¾ç¤º)
                if(!tip && l.getDay() === 1) {
                    const mg = l.getMonthGan();
                    if(SiHuaTips[mg]) {
                        tip = `<span class="tips-hl">ğŸ“… æœ¬æœˆç¤¾ä¼šè¶‹åŠ¿ (${mg}å¹²)ï¼š</span>${SiHuaTips[mg]}`;
                    }
                }
                // ä¼˜å…ˆçº§6: é»˜è®¤å…œåº•
                if(!tip) {
                    if(l.getZhiXing() === 'é™¤') tip = "ğŸ§¹ é™¤æ—¥ï¼šé€‚åˆå¤§æ‰«é™¤ï¼Œæ¸…ç†èº«å¿ƒè´Ÿè·ã€‚";
                    else tip = "ğŸŒˆ ä¿æŒå¹³å’Œå¿ƒæ€ï¼Œä¸“æ³¨å½“ä¸‹ï¼Œç¾å¥½è‡ªä¼šå‘ç”Ÿã€‚";
                }
                document.getElementById('todayAdvice').innerHTML = `<span class="tips-content">${tip}</span>`;
              

                // === è°ƒç”¨é™æ—¶é”¦å›Šæ£€æŸ¥å‡½æ•° ===
                 checkTimeCapsule(date);
                renderProView(l);
                document.getElementById('journalInput').value = localStorage.getItem('panna_j_'+getDateKey(date)) || "";
            } catch(e) { console.error(e); }
        }

        function renderAstroEvents() {
            const k = `${currentDate.getFullYear()}-${currentDate.getMonth()+1}`;
            let events = AstroDB[k] || [];
            const el = document.getElementById('astroList');
            
            if(events.length > 0) {
                events.sort((a,b) => parseInt(a.d) - parseInt(b.d));
                el.innerHTML = events.map(e => 
                    `<div class="astro-item"><span class="astro-date">${typeof e.d === 'string' ? e.d.replace('-', 'æ—¥-')+'æ—¥' : e.d+'æ—¥'}</span><span>${e.t}</span></div>`
                ).join('');
            } else {
                el.innerHTML = "<div style='text-align:center;color:#999;padding:10px;'>æœ¬æœˆæ˜Ÿè±¡å¹³ç¨³ï¼Œé€‚å®œæ²‰æ·€ã€‚</div>";
            }
        }

        function renderProView(l) {
            // 1. é£æ˜Ÿåˆ—è¡¨
            const yS = getNum(l.getYearNineStar());
            const mS = getNum(l.getMonthNineStar());
            const dS = getNum(l.getDayNineStar());
            const colorize = (n, txt) => {
                const colors = ["","blue","black","green","green","orange","gray","red","brown","purple"];
                return `<span style="color:var(--star-${getColorName(n)}); font-weight:bold;">${txt}</span>`;
            };
            document.getElementById('fsList').innerHTML = `
                <div class="star-list-item"><span style="color:#666">æµå¹´ (${l.getYearInGanZhi()})</span> <span class="star-tag">${colorize(yS, l.getYearNineStar().toString())}</span></div>
                <div class="star-list-item"><span style="color:#666">æµæœˆ (${l.getMonthInGanZhi()})</span> <span class="star-tag">${colorize(mS, l.getMonthNineStar().toString())}</span></div>
                <div class="star-list-item"><span style="color:#666">æµæ—¥ (${l.getDayInGanZhi()})</span> <span class="star-tag">${colorize(dS, l.getDayNineStar().toString())}</span></div>
            `;
            // 2. å››åŒ–è¡¨æ ¼
            const yg=l.getYearGan(), mg=l.getMonthGan(), dg=l.getDayGan();
            const getStars = (gan) => {
                const map = {"ç”²":["å»‰è´","ç ´å†›","æ­¦æ›²","å¤ªé˜³"],"ä¹™":["å¤©æœº","å¤©æ¢","ç´«å¾®","å¤ªé˜´"],"ä¸™":["å¤©åŒ","å¤©æœº","æ–‡æ˜Œ","å»‰è´"],"ä¸":["å¤ªé˜´","å¤©åŒ","å¤©æœº","å·¨é—¨"],"æˆŠ":["è´ªç‹¼","å¤ªé˜´","å³å¼¼","å¤©æœº"],"å·±":["æ­¦æ›²","è´ªç‹¼","å¤©æ¢","æ–‡æ›²"],"åºš":["å¤ªé˜³","æ­¦æ›²","å¤ªé˜´","å¤©åŒ"],"è¾›":["å·¨é—¨","å¤ªé˜³","æ–‡æ›²","æ–‡æ˜Œ"],"å£¬":["å¤©æ¢","ç´«å¾®","å·¦è¾…","æ­¦æ›²"],"ç™¸":["ç ´å†›","å·¨é—¨","å¤ªé˜´","è´ªç‹¼"]};
                return map[gan] || ["-","-","-","-"];
            }
            
            const row = (lbl, s) => `
                <div class="sh-cell sh-label">${lbl}</div>
                <div class="sh-cell c-lu">${s[0]}</div>
                <div class="sh-cell c-quan">${s[1]}</div>
                <div class="sh-cell c-ke">${s[2]}</div>
                <div class="sh-cell c-ji">${s[3]}</div>
            `;
            document.getElementById('sihuaContent').innerHTML = `
                ${row(yg+'å¹´', getStars(yg))}
                ${row(mg+'æœˆ', getStars(mg))}
                ${row(dg+'æ—¥', getStars(dg))}
            `;
        }

        // é™æ—¶é”¦å›Š
    function checkTimeCapsule(date) {
            const m = date.getMonth() + 1;
            const d = date.getDate();
            const y = date.getFullYear();
            const container = document.getElementById('specialEventContainer');
            if (y === 2025 && m === 12 && d >= 21) {
                container.style.display = 'block';
                document.getElementById('specialEventTitle').innerText = "ğŸ”¥ 2026ä¸™åˆå¹´é£æ°´å¸ƒå±€å‰ç»";
                window.currentSpecialContent = {
                    title: "2026ä¸™åˆå¹´Â·æµå¹´é£æ°´",
                    content: `<div style="text-align:center;margin-bottom:15px;"><h2 style="color:#c0392b">ä¸™åˆå¤©æ²³æ°´</h2><p style="color:#666">ç«æ°”æœ€æ—ºçš„ä¸€å¹´ï¼Œé‡åœ¨ä¿®å¿ƒï¼Œæ³¨æ„é˜²ç«ç¾åŠæ°´ç¾</p></div><p><b>é£æ°´å¸ƒå±€</b><br>1.æ­£ä¸œæ–¹ï¼ˆæ­£è´¢ä½ï¼‰å®¶å®…ä¸œé¢ä¸ºä¹¦æˆ¿ã€åŠå…¬å®¤æˆ–å¤§é—¨ï¼Œå¯å……åˆ†å€ŸåŠ©æ­¤æ˜Ÿèƒ½é‡ç§¯ç´¯è´¢å¯Œã€‚<br>2.ä¸œå—æ–¹ï¼ˆå§»ç¼˜ä½ï¼‰å®œå¸ƒç½®çº¢è‰²ã€ç²‰è‰²ã€ç´«è‰²ç‰©ä»¶æ¥å¢å¼ºå–œæ°”.<br>3.ä¸­å®«ï¼ˆäººç¼˜æ¡ƒèŠ±ä½ï¼‰ä¿æŒå®¶å®…ä¸­å¿ƒå¹²å‡€æ˜äº®ï¼Œæœ‰åŠ©äºè´µäººç›¸åŠ©ã€äº‹ä¸šæ™‹å‡ã€‚<br>4.ä¸œåŒ—æ–¹ï¼ˆæ–‡æ˜Œä½ï¼‰é€‚åˆå¸ƒç½®ä¹¦æˆ¿æˆ–å­¦ä¹ åŒºåŸŸã€‚<br>5. æ­£å—æ–¹ï¼ˆå¤ªå²æ–¹åŠäº”é»„ç…ï¼‰å®œä¿æŒå¹²å‡€æ•´æ´ï¼Œåˆ‡å¿ŒåŠ¨åœŸã€‚<br>6. è¥¿åŒ—æ–¹ï¼ˆç—…ç¬¦ä½ï¼‰å®œæ‘†æ”¾é“œè‘«èŠ¦åŒ–è§£ã€‚</p>`
            }
            } else {
                container.style.display = 'none';
            }
        }

        function openSpecialModal() {
            if (!window.currentSpecialContent) return;
            document.getElementById('spModalTitle').innerText = window.currentSpecialContent.title;
            document.getElementById('spModalContent').innerHTML = window.currentSpecialContent.content;
            document.getElementById('specialModal').classList.add('show');
        }
        function closeSpecialModal() { document.getElementById('specialModal').classList.remove('show'); }
        
        function mapDir(d) { const m={"å":"æ­£åŒ—","ç¦»":"æ­£å—","éœ‡":"æ­£ä¸œ","å…‘":"æ­£è¥¿","å·½":"ä¸œå—","å¤":"è¥¿å—","è‰®":"ä¸œåŒ—","ä¹¾":"è¥¿åŒ—","ä¸­":"ä¸­å®«"}; return m[d]||d; }
        function getNum(s) { let n=parseInt(s.getNumber()); return isNaN(n)?5:n; }
        function getColorName(n) { const c=["","water","earth","wood","wood","earth","metal","metal","earth","fire"]; return c[n] || 'earth'; }
        function getDateKey(d) { return `${d.getFullYear()}-${d.getMonth() + 1}-${d.getDate()}`; } // Changed to +1 for correct month in key
        function isSameDay(d1, d2) { return d1.getFullYear()===d2.getFullYear() && d1.getMonth()===d2.getMonth() && d1.getDate()===d2.getDate(); }
        
        function exportJournal() {
            let txt = "Panna æ—¥è®°å¤‡ä»½\n\n";
            let count = 0;
            for(let i=0; i<localStorage.length; i++) {
                let k = localStorage.key(i);
                if(k.startsWith('panna_j_')) {
                    count++;
                    txt += `[${k.replace('panna_j_','')}]\n${localStorage.getItem(k)}\n\n`;
                }
            }
            if (count === 0) {
                alert("æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æ—¥è®°ã€‚");
                return;
            }
            const blob = new Blob([txt], {type:'text/plain;charset=utf-8'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `panna_journal_backup_${new Date().toISOString().slice(0,10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert(`å·²æˆåŠŸå¯¼å‡º ${count} ç¯‡æ—¥è®°ï¼`);
        }
    </script>
</body>
</html>
